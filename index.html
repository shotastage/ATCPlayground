<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tokyu 5050 Series ATC Sim</title>
    <style>
        /* --- フォントの読み込み（デジタル数字用） --- */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root {
            --bg-color: #101010;
            --panel-color: #202020;
            --text-color: #fff;
            --accent-color: #da0442; /* 東横レッド */
            --lcd-bg: #000;
            --lcd-scale: #fff;
            --lcd-needle: #fff;
            --lcd-atc: #ff8c00; /* ATCマーカーのオレンジ */
            --lcd-over: #ff0000;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- 1. 路線図（TIMS風） --- */
        #route-info {
            flex: 2;
            background: #1a1a1a;
            color: #fff;
            position: relative;
            border-bottom: 2px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        #line-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .line-badge {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 2px;
        }
        
        .station-info {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }
        .st-name {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .next-label {
            font-size: 12px;
            color: #aaa;
            margin-right: 10px;
        }
        
        /* 残り距離バー */
        .dist-bar-bg {
            width: 100%;
            height: 10px;
            background: #333;
            margin-top: 10px;
            position: relative;
            border-radius: 5px;
            overflow: hidden;
        }
        .dist-bar-fill {
            height: 100%;
            background: #00b894;
            width: 0%;
            transition: width 0.1s linear;
        }
        #distance-text {
            text-align: right;
            font-family: 'Share Tech Mono', monospace;
            font-size: 24px;
            color: #00b894;
            margin-top: 5px;
        }
        #distance-text.near { color: #e74c3c; }

        /* --- 2. 運転台（グラスコックピット） --- */
        #cockpit {
            flex: 5;
            background: #151515;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* LCDモニター風の枠 */
        #lcd-panel {
            position: relative;
            width: 320px;
            height: 320px;
            background: #000;
            border: 4px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        canvas { width: 100%; height: 100%; }

        /* デジタル速度表示（Canvasの上にHTMLで配置） */
        #center-speed {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        #digital-val {
            font-family: 'Share Tech Mono', monospace;
            font-size: 60px;
            color: #fff;
            line-height: 1;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        #unit-label {
            font-size: 14px;
            color: #aaa;
            margin-top: -5px;
        }

        /* ATC動作ランプ */
        #atc-lamp-box {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .indicator-lamp {
            width: 80px;
            padding: 4px;
            font-size: 12px;
            text-align: center;
            background: #222;
            color: #555;
            border: 1px solid #444;
            border-radius: 4px;
            font-weight: bold;
        }
        .indicator-lamp.active {
            background: #da0442;
            color: #fff;
            box-shadow: 0 0 10px #da0442;
            border-color: #ff5e89;
        }
        
        /* --- 3. マスコン --- */
        #mascon-area {
            flex: 3;
            background: #202020;
            border-top: 2px solid #444;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #notch-indicator {
            font-family: 'Share Tech Mono', monospace;
            font-size: 32px;
            font-weight: bold;
            background: #000;
            color: #fff;
            padding: 5px 40px;
            border: 2px solid #555;
            border-radius: 6px;
            margin-bottom: 15px;
            min-width: 120px;
            text-align: center;
        }
        /* ノッチごとの色 */
        .n-p { color: #00b894 !important; text-shadow: 0 0 5px #00b894; }
        .n-n { color: #fff !important; }
        .n-b { color: #e67e22 !important; text-shadow: 0 0 5px #e67e22; }
        .n-eb { color: #ff0000 !important; text-shadow: 0 0 10px #ff0000; }

        /* スライダー */
        input[type=range] {
            -webkit-appearance: none;
            width: 95%;
            height: 60px;
            background: linear-gradient(90deg, #c0392b 0%, #e67e22 30%, #7f8c8d 50%, #2980b9 70%, #2ecc71 100%);
            border-radius: 30px;
            outline: none;
            border: 4px solid #111;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #ecf0f1;
            border: 4px solid #95a5a6;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        /* ポップアップ・オーバーレイ */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #overlay h2 { font-size: 24px; margin-bottom: 10px; color: #fff; }
        #overlay p { color: #ccc; margin-bottom: 20px; }
        #btn-start {
            padding: 15px 40px;
            font-size: 20px;
            background: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(218, 4, 66, 0.4);
        }
        #score-display {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            min-height: 30px;
        }

    </style>
</head>
<body>

    <div id="route-info">
        <div id="line-indicator">
            <span class="line-badge" id="line-badge" style="background:#00418e;">MM線</span>
            <span style="font-size:12px; color:#aaa;">Next Station</span>
        </div>
        <div class="station-info">
            <div>
                <span class="next-label">次は</span>
                <span class="st-name" id="next-st-name">元町・中華街</span>
            </div>
            <div id="distance-text">0m</div>
        </div>
        <div class="dist-bar-bg">
            <div class="dist-bar-fill" id="dist-bar"></div>
        </div>
    </div>

    <div id="cockpit">
        <div id="lcd-panel">
            <canvas id="speedGraph" width="320" height="320"></canvas>
            
            <div id="center-speed">
                <div id="digital-val">0</div>
                <div id="unit-label">km/h</div>
            </div>

            <div id="atc-lamp-box">
                <div class="indicator-lamp" id="lamp-atc">ATC</div>
                <div class="indicator-lamp" id="lamp-p">P</div>
                <div class="indicator-lamp" id="lamp-b">B</div>
            </div>
        </div>
    </div>

    <div id="mascon-area">
        <div id="notch-indicator" class="n-n">N</div>
        <input type="range" id="mascon" min="-5" max="4" value="0" step="1">
        <div style="display:flex; justify-content:space-between; width:90%; font-size:10px; color:#888; margin-top:5px;">
            <span>EB</span>
            <span>B4</span>
            <span>N</span>
            <span>P4</span>
        </div>
    </div>

    <div id="overlay">
        <h2 id="ov-title">Tokyu 5050 Series Sim</h2>
        <div id="score-display"></div>
        <p id="ov-desc">音声が出ます。音量にご注意ください。<br>画面タップで開始します。</p>
        <button id="btn-start">運転開始</button>
    </div>

<script>
    /* 【東急5050系風 ATCシミュレーター仕様】
       - グラスコックピット（LCD）描画
       - ATCパターン制御（階段状減速）
       - ATCベル音（Web Audio API）
    */

    // --- 定数・設定 ---
    const STATIONS = [
        { name: "元町・中華街", dist: 0, line: "みなとみらい線", color: "#00418e" },
        { name: "日本大通り", dist: 800, line: "みなとみらい線", color: "#00418e" },
        { name: "馬車道", dist: 600, line: "みなとみらい線", color: "#00418e" },
        { name: "みなとみらい", dist: 700, line: "みなとみらい線", color: "#00418e" },
        { name: "新高島", dist: 800, line: "みなとみらい線", color: "#00418e" },
        { name: "横浜", dist: 1000, line: "東横線", color: "#da0442" },
        { name: "反町", dist: 900, line: "東横線", color: "#da0442" },
        { name: "東白楽", dist: 800, line: "東横線", color: "#da0442" },
        { name: "白楽", dist: 700, line: "東横線", color: "#da0442" },
        { name: "妙蓮寺", dist: 1000, line: "東横線", color: "#da0442" },
        { name: "菊名", dist: 1200, line: "東横線", color: "#da0442" },
        { name: "大倉山", dist: 1000, line: "東横線", color: "#da0442" },
        { name: "綱島", dist: 1500, line: "東横線", color: "#da0442" },
        { name: "日吉", dist: 1200, line: "東横線", color: "#da0442" },
        { name: "元住吉", dist: 1000, line: "東横線", color: "#da0442" },
        { name: "武蔵小杉", dist: 1100, line: "東横線", color: "#da0442" },
        { name: "新丸子", dist: 600, line: "東横線", color: "#da0442" },
        { name: "多摩川", dist: 900, line: "東横線", color: "#da0442" },
        { name: "田園調布", dist: 800, line: "東横線", color: "#da0442" },
        { name: "自由が丘", dist: 1200, line: "東横線", color: "#da0442" },
        { name: "都立大学", dist: 1100, line: "東横線", color: "#da0442" },
        { name: "学芸大学", dist: 1100, line: "東横線", color: "#da0442" },
        { name: "祐天寺", dist: 900, line: "東横線", color: "#da0442" },
        { name: "中目黒", dist: 1000, line: "東横線", color: "#da0442" },
        { name: "代官山", dist: 800, line: "東横線", color: "#da0442" },
        { name: "渋谷", dist: 1200, line: "東横線", color: "#da0442" }
    ];

    // 物理パラメータ
    const MAX_SPEED_DISPLAY = 140; 
    const ACCEL_RATE = 3.3 / 4; // 3.3km/h/s (東急車の高性能加速)
    const BRAKE_RATE = 4.0 / 4; // 常用最大
    const EB_RATE = 6.0;
    const FRICTION = 0.02; // 走行抵抗

    // --- Web Audio API (ATCベル) ---
    let audioCtx;
    
    function initAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
    }

    function playATCChime() {
        if (!audioCtx) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        // 5050系の「チン！」音の再現
        // 基本周波数高めの正弦波
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1800, t); 
        osc.frequency.exponentialRampToValueAtTime(1000, t + 0.2); // 少し音が下がる余韻

        // エンベロープ（アタック早め、リリース短め）
        gain.gain.setValueAtTime(0, t);
        gain.gain.linearRampToValueAtTime(0.2, t + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);

        osc.start(t);
        osc.stop(t + 0.4);
    }


    // --- ゲーム状態変数 ---
    let stIndex = 0;
    let distNext = 0;
    let totalDist = 0;
    let speed = 0; // km/h
    let notch = 0; // -5(EB) ~ 4(P4)
    let atcLimit = 0;
    let isAtcBrake = false;
    let isStopped = true;
    let animationId;

    // DOM
    const cvs = document.getElementById('speedGraph');
    const ctx = cvs.getContext('2d');
    const elDigi = document.getElementById('digital-val');
    const elMascon = document.getElementById('mascon');
    const elNotch = document.getElementById('notch-indicator');
    const elNextSt = document.getElementById('next-st-name');
    const elLineBadge = document.getElementById('line-badge');
    const elDistText = document.getElementById('distance-text');
    const elDistBar = document.getElementById('dist-bar');
    
    const lampAtc = document.getElementById('lamp-atc');
    const lampP = document.getElementById('lamp-p');
    const lampB = document.getElementById('lamp-b');

    const overlay = document.getElementById('overlay');
    const ovTitle = document.getElementById('ov-title');
    const ovDesc = document.getElementById('ov-desc');
    const btnStart = document.getElementById('btn-start');
    const scoreDisp = document.getElementById('score-display');

    // --- 初期化 ---
    setupStation(0);

    btnStart.addEventListener('click', () => {
        if(!audioCtx) initAudio();
        overlay.style.display = 'none';
        scoreDisp.textContent = "";
        
        if(stIndex >= STATIONS.length -1) {
            // 全クリ後の再スタートなどあれば
            return;
        }

        isStopped = false;
        atcLimit = 30; // 出発信号
        // 出発時のATC音
        playATCChime();
        
        lastTime = performance.now();
        loop();
    });

    elMascon.addEventListener('input', (e) => {
        notch = parseInt(e.target.value);
        updateNotchUI(notch);
    });

    function updateNotchUI(val) {
        let txt = "N";
        let cls = "n-n";
        lampP.classList.remove('active');
        lampB.classList.remove('active');

        if(val > 0) {
            txt = "P" + val;
            cls = "n-p";
            lampP.classList.add('active');
        } else if (val < 0) {
            lampB.classList.add('active');
            if (val === -5) {
                txt = "EB";
                cls = "n-eb";
            } else {
                txt = "B" + Math.abs(val);
                cls = "n-b";
            }
        }
        elNotch.textContent = txt;
        elNotch.className = "";
        elNotch.classList.add(cls);
    }

    function setupStation(idx) {
        stIndex = idx;
        isStopped = true;
        speed = 0;
        notch = 0;
        elMascon.value = 0;
        updateNotchUI(0);
        isAtcBrake = false;

        if (idx < STATIONS.length - 1) {
            const next = STATIONS[idx+1];
            distNext = next.dist;
            totalDist = next.dist;
            
            elNextSt.textContent = next.name;
            elLineBadge.textContent = (next.line === "東横線") ? "TY 東横線" : "MM みなとみらい線";
            elLineBadge.style.backgroundColor = next.color;

            ovTitle.textContent = STATIONS[idx].name + " 停車中";
            ovDesc.innerHTML = "次は " + next.name + " です。<br>出発ボタンを押してください。";
            btnStart.style.display = "inline-block";
            overlay.style.display = "flex";
        } else {
            // 終点
            elNextSt.textContent = "終点";
            ovTitle.textContent = "全区間 走破！";
            ovDesc.textContent = "お疲れ様でした。";
            btnStart.style.display = "none";
            overlay.style.display = "flex";
        }
        draw();
    }

    // --- メインループ ---
    let lastTime = 0;
    function loop() {
        if(isStopped) return;
        
        const now = performance.now();
        const dt = (now - lastTime) / 1000;
        lastTime = now;

        updatePhysics(dt);
        updateATC();
        updateUI();
        draw();

        animationId = requestAnimationFrame(loop);
    }

    function updatePhysics(dt) {
        let accel = 0;
        // 加減速
        if(notch > 0) {
            accel = notch * ACCEL_RATE;
        } else if(notch < 0) {
            if(notch === -5) accel = -EB_RATE;
            else accel = notch * BRAKE_RATE;
        }

        // ATC自動ブレーキ（実車はパターン超過で常用最大～非常ブレーキがかかる）
        // ここでは超過で強力なブレーキがかかる仕様とする
        if(speed > atcLimit + 1.0) { 
            isAtcBrake = true;
            if(accel > -4.0) accel = -4.5; // 強制減速
        } else {
            isAtcBrake = false;
        }

        // 走行抵抗
        if(speed > 0) accel -= FRICTION;

        // 速度更新
        speed += accel * dt;
        if(speed < 0) speed = 0;

        // 位置更新
        const mps = speed / 3.6;
        distNext -= mps * dt;

        // 停車判定
        // 速度ほぼ0、ノッチN以下、残り距離60m以内
        if(speed < 0.1 && notch <= 0 && Math.abs(distNext) < 60 && !isStopped) {
            speed = 0;
            finishStop();
        }
    }

    function updateATC() {
        // CS-ATC / ORP パターン
        // 階段状に制限速度を下げる
        let nextLimit = 110;

        if (distNext <= 10) {
            nextLimit = 0; // 絶対停止
        } else if (distNext < 100) {
            nextLimit = 30; // 進入
        } else if (distNext < 200) {
            nextLimit = 45;
        } else if (distNext < 300) {
            nextLimit = 55;
        } else if (distNext < 450) {
            nextLimit = 65;
        } else if (distNext < 600) {
            nextLimit = 80;
        } else if (distNext < 800) {
            nextLimit = 100;
        } else {
            nextLimit = 110;
        }

        // 変化があったら音を鳴らす
        if(nextLimit !== atcLimit) {
            atcLimit = nextLimit;
            playATCChime();
        }
    }

    function finishStop() {
        isStopped = true;
        cancelAnimationFrame(animationId);
        
        const dist = Math.floor(distNext);
        let msg = "";
        let col = "";
        
        if(Math.abs(dist) <= 2) {
            msg = "Just Stop! 誤差 " + dist + "m";
            col = "#2ecc71";
        } else if (dist > 0) {
            msg = "手前停車 残り " + dist + "m";
            col = "#f1c40f";
        } else {
            msg = "オーバーラン " + Math.abs(dist) + "m";
            col = "#e74c3c";
        }
        
        scoreDisp.textContent = msg;
        scoreDisp.style.color = col;
        
        // 少し待って次へ
        setTimeout(() => {
            setupStation(stIndex + 1);
        }, 2000);
    }

    function updateUI() {
        elDigi.textContent = Math.floor(speed);
        
        // 距離表示
        let d = Math.floor(distNext);
        elDistText.textContent = d + "m";
        if(d < 100) elDistText.classList.add('near');
        else elDistText.classList.remove('near');

        // プログレスバー
        let p = 0;
        if(totalDist > 0) p = 100 - (distNext / totalDist * 100);
        if(p < 0) p = 0; 
        if(p > 100) p = 100;
        elDistBar.style.width = p + "%";

        // ATCランプ
        if(isAtcBrake) {
            lampAtc.classList.add('active');
            // ATCブレーキ中は背景を赤く点滅させるなどの演出も可
        } else {
            lampAtc.classList.remove('active');
        }
    }

    // --- Canvas 描画（グラスコックピット風） ---
    function draw() {
        // 画面クリア
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        
        const cx = cvs.width / 2;
        const cy = cvs.height / 2;
        const r = 140; // 半径

        // 角度設定 (左下135度 ～ 右下405度)
        const startDeg = 135;
        const endDeg = 405;
        const toRad = Math.PI / 180;

        // 1. 目盛り描画
        for (let i = 0; i <= MAX_SPEED_DISPLAY; i += 2) {
            const ratio = i / MAX_SPEED_DISPLAY;
            const deg = startDeg + ratio * (endDeg - startDeg);
            const rad = deg * toRad;
            
            const isMain = (i % 20 === 0);
            const isSub = (i % 10 === 0);
            
            let len = 5;
            if(isMain) len = 15;
            else if(isSub) len = 10;

            // 通常色: 白
            // ATC超過時: 赤くする演出
            let tickColor = "#fff";
            if(i > atcLimit && speed > atcLimit) {
                 tickColor = "#500"; // 制限域のベース色
            }

            const x1 = cx + Math.cos(rad) * (r - len);
            const y1 = cy + Math.sin(rad) * (r - len);
            const x2 = cx + Math.cos(rad) * r;
            const y2 = cy + Math.sin(rad) * r;

            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = tickColor;
            ctx.lineWidth = isMain ? 3 : (isSub ? 2 : 1);
            ctx.stroke();

            // 数字
            if (isMain) {
                const tx = cx + Math.cos(rad) * (r - 35);
                const ty = cy + Math.sin(rad) * (r - 35);
                ctx.fillStyle = "#fff";
                ctx.font = "bold 16px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(i, tx, ty);
            }
        }

        // 2. ATC制限マーカー（外周のオレンジ三角）
        // 5050系LCDでは外周を指す三角形が表示される
        if (atcLimit <= MAX_SPEED_DISPLAY) {
            const atcRatio = atcLimit / MAX_SPEED_DISPLAY;
            const atcDeg = startDeg + atcRatio * (endDeg - startDeg);
            const atcRad = atcDeg * toRad;
            
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(atcRad);
            ctx.beginPath();
            // 外側から内側へ向く三角
            ctx.moveTo(r + 5, 0);
            ctx.lineTo(r + 20, -8);
            ctx.lineTo(r + 20, 8);
            ctx.fillStyle = "#ff8c00"; // オレンジ
            ctx.fill();
            ctx.restore();
        }
        
        // 3. 超過ゾーンの表示（赤帯）
        if (speed > atcLimit) {
            // ATC制限から現在の速度までの帯を赤くする
            const limRatio = atcLimit / MAX_SPEED_DISPLAY;
            const spdRatio = Math.min(speed, MAX_SPEED_DISPLAY) / MAX_SPEED_DISPLAY;
            
            const limAng = (startDeg + limRatio * (endDeg - startDeg)) * toRad;
            const spdAng = (startDeg + spdRatio * (endDeg - startDeg)) * toRad;

            ctx.beginPath();
            ctx.arc(cx, cy, r - 5, limAng, spdAng, false);
            ctx.strokeStyle = "rgba(255, 0, 0, 0.5)";
            ctx.lineWidth = 10;
            ctx.stroke();
        }

        // 4. 速度針（白い針）
        const spdRatio = speed / MAX_SPEED_DISPLAY;
        const spdDeg = startDeg + spdRatio * (endDeg - startDeg);
        const spdRad = spdDeg * toRad;

        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(spdRad);
        
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(r - 10, 0);
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        
        // 速度超過時は針も赤くする
        if (speed > atcLimit && atcLimit > 0) {
             ctx.strokeStyle = "#ff0000";
             ctx.shadowBlur = 10;
             ctx.shadowColor = "red";
        } else {
             ctx.shadowBlur = 5;
             ctx.shadowColor = "white";
        }
        
        ctx.stroke();
        ctx.restore();

        // 中心キャップ
        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, Math.PI * 2);
        ctx.fillStyle = "#333";
        ctx.fill();
    }

    // 初回描画
    draw();

</script>
</body>
</html>