<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tokyu 5050 Series ATC Sim (Type Select)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@400;700&display=swap');

        :root {
            --bg-color: #101010;
            --panel-color: #202020;
            --text-color: #fff;
            --accent-color: #da0442; 
            
            /* 種別カラー */
            --col-local: #2980b9;    /* 各停：青 */
            --col-exp: #c0392b;      /* 急行：赤 */
            --col-com-exp: #e67e22;  /* 通特：オレンジ */
            --col-ltd-exp: #f39c12;  /* 特急：金/オレンジ */
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Sans JP', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- タイトル画面（種別選択） --- */
        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
            z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #title-screen h1 {
            font-size: 28px; margin-bottom: 10px; color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        .type-btn-container {
            display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px;
        }
        .type-btn {
            padding: 15px; font-size: 18px; font-weight: bold; color: #fff;
            border: none; border-radius: 8px; cursor: pointer; text-align: left;
            position: relative; overflow: hidden; transition: transform 0.1s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            font-family: 'Noto Sans JP', sans-serif;
        }
        .type-btn:active { transform: scale(0.98); }
        .type-btn::after {
            content: 'Select'; position: absolute; right: 15px; top: 50%;
            transform: translateY(-50%); font-size: 12px; opacity: 0.7;
        }
        
        /* 種別ごとのスタイル */
        .btn-local { background: var(--col-local); border-left: 6px solid #fff; }
        .btn-exp { background: var(--col-exp); border-left: 6px solid #fff; }
        .btn-com { background: var(--col-com-exp); border-left: 6px solid #fff; }
        .btn-ltd { background: var(--col-ltd-exp); border-left: 6px solid #fff; }

        /* --- 路線図エリア --- */
        #route-info {
            flex: 2;
            background: #1a1a1a;
            position: relative;
            border-bottom: 2px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }
        #line-indicator { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .line-badge { font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 2px; color:#fff;}
        .type-badge { font-size: 14px; font-weight: bold; padding: 2px 10px; border-radius: 2px; color:#fff; margin-left: auto;}
        
        .station-info { display: flex; justify-content: space-between; align-items: baseline; }
        .st-name { font-size: 22px; font-weight: bold; letter-spacing: 1px; }
        .next-label { font-size: 12px; color: #aaa; margin-right: 10px; }
        .dist-bar-bg { width: 100%; height: 10px; background: #333; margin-top: 10px; position: relative; border-radius: 5px; overflow: hidden; }
        .dist-bar-fill { height: 100%; background: #00b894; width: 0%; transition: width 0.1s linear; }
        #distance-text { text-align: right; font-family: 'Share Tech Mono', monospace; font-size: 24px; color: #00b894; margin-top: 5px; }
        #distance-text.near { color: #e74c3c; }

        /* --- コックピット --- */
        #cockpit {
            flex: 5;
            background: #151515;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        #lcd-panel {
            position: relative; width: 320px; height: 320px; background: #000;
            border: 4px solid #333; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        canvas { width: 100%; height: 100%; }

        #center-speed {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;
        }
        #digital-val {
            font-family: 'Share Tech Mono', monospace; font-size: 60px; color: #fff;
            line-height: 1; text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        #unit-label { font-size: 14px; color: #aaa; margin-top: -5px; }

        #atc-lamp-box {
            position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 5px;
        }
        .indicator-lamp {
            width: 80px; padding: 4px; font-size: 12px; text-align: center;
            background: #222; color: #555; border: 1px solid #444; border-radius: 4px; font-weight: bold;
        }
        .indicator-lamp.active { background: #da0442; color: #fff; box-shadow: 0 0 10px #da0442; border-color: #ff5e89; }
        .indicator-lamp.active-green { background: #2ecc71; color: #fff; box-shadow: 0 0 10px #2ecc71; border-color: #27ae60; }

        /* --- マスコン --- */
        #mascon-area {
            flex: 3; background: #202020; border-top: 2px solid #444;
            padding: 10px; display: flex; flex-direction: column; align-items: center;
        }
        #notch-indicator {
            font-family: 'Share Tech Mono', monospace; font-size: 32px; font-weight: bold;
            background: #000; color: #fff; padding: 5px 40px; border: 2px solid #555;
            border-radius: 6px; margin-bottom: 15px; min-width: 120px; text-align: center;
        }
        .n-p { color: #00b894 !important; text-shadow: 0 0 5px #00b894; }
        .n-n { color: #fff !important; }
        .n-b { color: #e67e22 !important; text-shadow: 0 0 5px #e67e22; }
        .n-eb { color: #ff0000 !important; text-shadow: 0 0 10px #ff0000; }

        input[type=range] {
            -webkit-appearance: none; width: 95%; height: 60px;
            background: linear-gradient(90deg, #c0392b 0%, #e67e22 30%, #7f8c8d 50%, #2980b9 70%, #2ecc71 100%);
            border-radius: 30px; outline: none; border: 4px solid #111;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 50px; height: 50px; border-radius: 50%;
            background: #ecf0f1; border: 4px solid #95a5a6; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        /* 運転開始前オーバーレイ */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; /* 初期は非表示(タイトル画面が上) */
            flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        #overlay h2 { font-size: 24px; margin-bottom: 10px; color: #fff; }
        #overlay p { color: #ccc; margin-bottom: 20px; }
        #btn-start {
            padding: 15px 40px; font-size: 20px; background: var(--accent-color); color: #fff;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        #score-display { font-size: 20px; font-weight: bold; margin-bottom: 20px; min-height: 30px; }
    </style>
</head>
<body>

    <div id="title-screen">
        <h1>Tokyu 5050 ATC Sim</h1>
        <p style="color:#aaa; margin-bottom:20px;">運転種別を選択してください</p>
        <div class="type-btn-container">
            <button class="type-btn btn-local" onclick="selectType('local')">各駅停車<br><span style="font-size:12px">Local</span></button>
            <button class="type-btn btn-exp" onclick="selectType('express')">急行<br><span style="font-size:12px">Express</span></button>
            <button class="type-btn btn-com" onclick="selectType('com_exp')">通勤特急<br><span style="font-size:12px">Commuter Ltd. Exp.</span></button>
            <button class="type-btn btn-ltd" onclick="selectType('ltd_exp')">特急<br><span style="font-size:12px">Limited Express</span></button>
        </div>
    </div>

    <div id="route-info">
        <div id="line-indicator">
            <span class="line-badge" id="line-badge" style="background:#00418e;">MM線</span>
            <span class="type-badge" id="type-badge" style="background:#2980b9;">Local</span>
        </div>
        <div class="station-info">
            <div>
                <span class="next-label">次は</span>
                <span class="st-name" id="next-st-name">元町・中華街</span>
            </div>
            <div id="distance-text">0m</div>
        </div>
        <div class="dist-bar-bg">
            <div class="dist-bar-fill" id="dist-bar"></div>
        </div>
    </div>

    <div id="cockpit">
        <div id="lcd-panel">
            <canvas id="speedGraph" width="320" height="320"></canvas>
            <div id="center-speed">
                <div id="digital-val">0</div>
                <div id="unit-label">km/h</div>
            </div>
            <div id="atc-lamp-box">
                <div class="indicator-lamp" id="lamp-atc">ATC</div>
                <div class="indicator-lamp" id="lamp-p">P</div>
                <div class="indicator-lamp" id="lamp-b">B</div>
            </div>
        </div>
    </div>

    <div id="mascon-area">
        <div id="notch-indicator" class="n-n">N</div>
        <input type="range" id="mascon" min="-5" max="4" value="0" step="1">
        <div style="display:flex; justify-content:space-between; width:90%; font-size:10px; color:#888; margin-top:5px;">
            <span>EB</span>
            <span>B4</span>
            <span>N</span>
            <span>P4</span>
        </div>
    </div>

    <div id="overlay">
        <h2 id="ov-title">Station Stopped</h2>
        <div id="score-display"></div>
        <p id="ov-desc">Departure Check</p>
        <button id="btn-start">発車！</button>
    </div>

<script>
    // --- 全駅データ（区間距離は概算） ---
    // dist: 「前の駅からこの駅までの距離」
    // stopFlags: { local:true, exp:true, com:true, ltd:true }
    
    const RAW_STATIONS = [
        { name: "元町・中華街", dist: 0,    line: "みなとみらい線", color: "#00418e", stops: {local:1, exp:1, com:1, ltd:1} },
        { name: "日本大通り",   dist: 800,  line: "みなとみらい線", color: "#00418e", stops: {local:1, exp:1, com:1, ltd:0} }, // 特急通過
        { name: "馬車道",       dist: 600,  line: "みなとみらい線", color: "#00418e", stops: {local:1, exp:1, com:1, ltd:0} },
        { name: "みなとみらい", dist: 700,  line: "みなとみらい線", color: "#00418e", stops: {local:1, exp:1, com:1, ltd:1} },
        { name: "新高島",       dist: 800,  line: "みなとみらい線", color: "#00418e", stops: {local:1, exp:0, com:0, ltd:0} }, // 急行通過
        { name: "横浜",         dist: 1000, line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:1, ltd:1} },
        { name: "反町",         dist: 1000, line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "東白楽",       dist: 800,  line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "白楽",         dist: 700,  line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "妙蓮寺",       dist: 1000, line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "菊名",         dist: 1200, line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:1, ltd:1} },
        { name: "大倉山",       dist: 1000, line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "綱島",         dist: 1500, line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:0, ltd:0} }, // 急行停車、特急通過
        { name: "日吉",         dist: 1200, line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:1, ltd:0} }, // 通特停車、特急通過
        { name: "元住吉",       dist: 1000, line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "武蔵小杉",     dist: 1100, line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:1, ltd:1} },
        { name: "新丸子",       dist: 600,  line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "多摩川",       dist: 900,  line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:0, ltd:0} },
        { name: "田園調布",     dist: 800,  line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:0, ltd:0} },
        { name: "自由が丘",     dist: 1200, line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:1, ltd:1} },
        { name: "都立大学",     dist: 1100, line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "学芸大学",     dist: 1100, line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:0, ltd:0} },
        { name: "祐天寺",       dist: 900,  line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "中目黒",       dist: 1000, line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:1, ltd:1} },
        { name: "代官山",       dist: 800,  line: "東横線",       color: "#da0442", stops: {local:1, exp:0, com:0, ltd:0} },
        { name: "渋谷",         dist: 1200, line: "東横線",       color: "#da0442", stops: {local:1, exp:1, com:1, ltd:1} }
    ];

    // ゲームで使用する駅リスト（選択された種別に基づいて構築）
    let gameStations = [];
    let currentType = 'local';

    // ATCパターン [距離, 制限]
    const ATC_PATTERN = [
        { d: 15, v: 0 }, { d: 100, v: 30 }, { d: 200, v: 45 }, { d: 300, v: 55 }, 
        { d: 450, v: 65 }, { d: 600, v: 80 }, { d: 900, v: 100 }, { d: 99999, v: 110 }
    ];
    const MAX_SPEED_DISPLAY = 140; 
    const ACCEL_RATE = 3.3 / 4; 
    const BRAKE_RATE = 4.0 / 4; 
    const EB_RATE = 6.0;
    const FRICTION = 0.02;

    // Audio
    let audioCtx;
    function initAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
    }
    function playATCChime() {
        if (!audioCtx) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1800, t); 
        osc.frequency.exponentialRampToValueAtTime(1000, t + 0.2); 
        gain.gain.setValueAtTime(0, t);
        gain.gain.linearRampToValueAtTime(0.2, t + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
        osc.start(t);
        osc.stop(t + 0.4);
    }

    // State
    let stIndex = 0;
    let distNext = 0;
    let totalDist = 0;
    let speed = 0; 
    let notch = 0;
    let atcLimit = 0;
    let nextAtcLimit = 110; 
    let isAtcBrake = false;
    let isStopped = true;
    let animationId;

    // DOM
    const titleScreen = document.getElementById('title-screen');
    const typeBadge = document.getElementById('type-badge');
    
    const cvs = document.getElementById('speedGraph');
    const ctx = cvs.getContext('2d');
    const elDigi = document.getElementById('digital-val');
    const elMascon = document.getElementById('mascon');
    const elNotch = document.getElementById('notch-indicator');
    const elNextSt = document.getElementById('next-st-name');
    const elLineBadge = document.getElementById('line-badge');
    const elDistText = document.getElementById('distance-text');
    const elDistBar = document.getElementById('dist-bar');
    const lampAtc = document.getElementById('lamp-atc');
    const lampP = document.getElementById('lamp-p');
    const lampB = document.getElementById('lamp-b');
    const overlay = document.getElementById('overlay');
    const ovTitle = document.getElementById('ov-title');
    const ovDesc = document.getElementById('ov-desc');
    const btnStart = document.getElementById('btn-start');
    const scoreDisp = document.getElementById('score-display');

    // --- 種別選択処理 ---
    function selectType(type) {
        currentType = type;
        
        // 停車駅リストの構築
        // 通過駅の距離は、次の停車駅までの距離に加算する
        gameStations = [];
        let accumDist = 0;

        // 始発駅を追加
        gameStations.push({ ...RAW_STATIONS[0], dist: 0 });

        // 2駅目以降をスキャン
        for (let i = 1; i < RAW_STATIONS.length; i++) {
            const st = RAW_STATIONS[i];
            
            // 区間距離を加算
            accumDist += st.dist;

            // 停車判定
            let isStop = false;
            if (type === 'local' && st.stops.local) isStop = true;
            if (type === 'express' && st.stops.exp) isStop = true;
            if (type === 'com_exp' && st.stops.com) isStop = true;
            if (type === 'ltd_exp' && st.stops.ltd) isStop = true;

            if (isStop) {
                // 停車駅ならリストに追加。距離は「前の停車駅からここまでの累積距離」とする
                gameStations.push({ ...st, dist: accumDist });
                accumDist = 0; // リセット
            }
        }

        // UI更新
        let typeName = "";
        let typeColor = "";
        switch(type) {
            case 'local': typeName="Local"; typeColor="var(--col-local)"; break;
            case 'express': typeName="Express"; typeColor="var(--col-exp)"; break;
            case 'com_exp': typeName="Commuter Exp"; typeColor="var(--col-com-exp)"; break;
            case 'ltd_exp': typeName="Ltd. Exp"; typeColor="var(--col-ltd-exp)"; break;
        }
        typeBadge.textContent = typeName;
        typeBadge.style.background = typeColor;

        // タイトルを消してゲーム開始
        titleScreen.style.display = 'none';
        setupStation(0);
    }

    // --- ゲーム開始 ---
    btnStart.addEventListener('click', () => {
        if(!audioCtx) initAudio();
        overlay.style.display = 'none';
        scoreDisp.textContent = "";
        
        if(stIndex >= gameStations.length -1) return;

        isStopped = false;
        atcLimit = 30; 
        playATCChime();
        lastTime = performance.now();
        loop();
    });

    elMascon.addEventListener('input', (e) => {
        notch = parseInt(e.target.value);
        updateNotchUI(notch);
    });

    function updateNotchUI(val) {
        let txt = "N";
        let cls = "n-n";
        lampB.classList.remove('active');
        
        if(val > 0) {
            txt = "P" + val;
            cls = "n-p";
        } else if (val < 0) {
            lampB.classList.add('active');
            if (val === -5) {
                txt = "EB";
                cls = "n-eb";
            } else {
                txt = "B" + Math.abs(val);
                cls = "n-b";
            }
        }
        elNotch.textContent = txt;
        elNotch.className = "";
        elNotch.classList.add(cls);
    }

    function setupStation(idx) {
        stIndex = idx;
        isStopped = true;
        speed = 0;
        notch = 0;
        elMascon.value = 0;
        updateNotchUI(0);
        isAtcBrake = false;

        if (idx < gameStations.length - 1) {
            const current = gameStations[idx];
            const next = gameStations[idx+1];
            distNext = next.dist;
            totalDist = next.dist;
            
            elNextSt.textContent = next.name;
            elLineBadge.textContent = (next.line === "東横線") ? "TY 東横線" : "MM みなとみらい線";
            elLineBadge.style.backgroundColor = next.color;
            
            ovTitle.textContent = current.name + " 停車中";
            ovDesc.innerHTML = "次は <span style='font-size:1.2em;font-weight:bold'>" + next.name + "</span> です。<br>距離: " + next.dist + "m";
            btnStart.style.display = "inline-block";
            overlay.style.display = "flex";
        } else {
            elNextSt.textContent = "終点";
            ovTitle.textContent = "全区間 走破！";
            ovDesc.textContent = "お疲れ様でした。";
            btnStart.style.display = "none";
            overlay.style.display = "flex";
        }
        draw();
    }

    let lastTime = 0;
    function loop() {
        if(isStopped) return;
        const now = performance.now();
        const dt = (now - lastTime) / 1000;
        lastTime = now;

        updatePhysics(dt);
        updateATC();
        updateUI();
        draw();
        animationId = requestAnimationFrame(loop);
    }

    function updatePhysics(dt) {
        let accel = 0;
        if(notch > 0) accel = notch * ACCEL_RATE;
        else if(notch < 0) {
            if(notch === -5) accel = -EB_RATE;
            else accel = notch * BRAKE_RATE;
        }

        if(speed > atcLimit + 1.0) { 
            isAtcBrake = true;
            if(accel > -4.0) accel = -4.5;
        } else {
            isAtcBrake = false;
        }

        if(speed > 0) accel -= FRICTION;
        speed += accel * dt;
        if(speed < 0) speed = 0;

        const mps = speed / 3.6;
        distNext -= mps * dt;

        if(speed < 0.1 && notch <= 0 && Math.abs(distNext) < 60 && !isStopped) {
            speed = 0;
            finishStop();
        }
    }

    function updateATC() {
        let currentLim = 110;
        let nextLim = 110;

        for (let i = 0; i < ATC_PATTERN.length; i++) {
            if (distNext < ATC_PATTERN[i].d) {
                currentLim = ATC_PATTERN[i].v;
                if (i > 0) {
                    nextLim = ATC_PATTERN[i-1].v;
                } else {
                    nextLim = 0;
                }
                break;
            }
        }

        if(currentLim !== atcLimit) {
            atcLimit = currentLim;
            playATCChime();
        }
        nextAtcLimit = nextLim;
    }

    function finishStop() {
        isStopped = true;
        cancelAnimationFrame(animationId);
        const dist = Math.floor(distNext);
        let msg = "", col = "";
        if(Math.abs(dist) <= 2) { msg = "定位置停車! 誤差 " + dist + "m"; col = "#2ecc71"; }
        else if (dist > 0) { msg = "停止位置手前 残り " + dist + "m"; col = "#f1c40f"; }
        else { msg = "オーバーラン " + Math.abs(dist) + "m"; col = "#e74c3c"; }
        scoreDisp.textContent = msg;
        scoreDisp.style.color = col;
        setTimeout(() => { setupStation(stIndex + 1); }, 2000);
    }

    function updateUI() {
        elDigi.textContent = Math.floor(speed);
        let d = Math.floor(distNext);
        elDistText.textContent = d + "m";
        if(d < 100) elDistText.classList.add('near');
        else elDistText.classList.remove('near');
        
        let p = 0;
        if(totalDist > 0) p = 100 - (distNext / totalDist * 100);
        if(p < 0) p = 0; if(p > 100) p = 100;
        elDistBar.style.width = p + "%";

        if(isAtcBrake) {
            lampAtc.classList.add('active');
        } else {
            lampAtc.classList.remove('active');
        }

        if (nextAtcLimit < atcLimit && speed > nextAtcLimit) {
            lampP.classList.add('active-green');
        } else {
            lampP.classList.remove('active-green');
        }
    }

    function draw() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        const cx = cvs.width / 2, cy = cvs.height / 2, r = 140;
        const startDeg = 135, endDeg = 405, toRad = Math.PI / 180;

        for (let i = 0; i <= MAX_SPEED_DISPLAY; i += 2) {
            const ratio = i / MAX_SPEED_DISPLAY;
            const deg = startDeg + ratio * (endDeg - startDeg);
            const rad = deg * toRad;
            const isMain = (i % 20 === 0), isSub = (i % 10 === 0);
            let len = isMain ? 15 : (isSub ? 10 : 5);
            
            let tickColor = "#fff";
            if(i > atcLimit && speed > atcLimit) tickColor = "#500";
            
            const x1 = cx + Math.cos(rad) * (r - len);
            const y1 = cy + Math.sin(rad) * (r - len);
            const x2 = cx + Math.cos(rad) * r;
            const y2 = cy + Math.sin(rad) * r;
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = tickColor;
            ctx.lineWidth = isMain ? 3 : (isSub ? 2 : 1);
            ctx.stroke();

            if (isMain) {
                const tx = cx + Math.cos(rad) * (r - 35);
                const ty = cy + Math.sin(rad) * (r - 35);
                ctx.fillStyle = "#fff";
                ctx.font = "bold 16px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(i, tx, ty);
            }
        }

        if (nextAtcLimit < atcLimit && nextAtcLimit >= 0) {
            drawTriangle(cx, cy, r, nextAtcLimit, false);
        }

        drawTriangle(cx, cy, r, atcLimit, true);

        if (speed > atcLimit) {
            const limRatio = atcLimit / MAX_SPEED_DISPLAY;
            const spdRatio = Math.min(speed, MAX_SPEED_DISPLAY) / MAX_SPEED_DISPLAY;
            const limAng = (startDeg + limRatio * (endDeg - startDeg)) * toRad;
            const spdAng = (startDeg + spdRatio * (endDeg - startDeg)) * toRad;
            ctx.beginPath();
            ctx.arc(cx, cy, r - 5, limAng, spdAng, false);
            ctx.strokeStyle = "rgba(255, 0, 0, 0.5)";
            ctx.lineWidth = 10;
            ctx.stroke();
        }

        const spdRatio = speed / MAX_SPEED_DISPLAY;
        const spdDeg = startDeg + spdRatio * (endDeg - startDeg);
        const spdRad = spdDeg * toRad;
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(spdRad);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(r - 10, 0);
        ctx.strokeStyle = (speed > atcLimit && atcLimit > 0) ? "#ff0000" : "#fff";
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.shadowBlur = 5;
        ctx.shadowColor = (speed > atcLimit && atcLimit > 0) ? "red" : "white";
        ctx.stroke();
        ctx.restore();

        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, Math.PI * 2);
        ctx.fillStyle = "#333";
        ctx.fill();
    }

    function drawTriangle(cx, cy, r, val, isSolid) {
        if(val > MAX_SPEED_DISPLAY) return;
        const startDeg = 135, endDeg = 405, toRad = Math.PI / 180;
        const ratio = val / MAX_SPEED_DISPLAY;
        const deg = startDeg + ratio * (endDeg - startDeg);
        const rad = deg * toRad;
        
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(rad);
        ctx.beginPath();
        ctx.moveTo(r + 5, 0);
        ctx.lineTo(r + 25, -10);
        ctx.lineTo(r + 25, 10);
        ctx.closePath();
        
        if (isSolid) {
            ctx.fillStyle = "#ff8c00"; 
            ctx.fill();
        } else {
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#ff8c00"; 
            ctx.stroke();
            ctx.fillStyle = "#000"; 
            ctx.fill();
        }
        ctx.restore();
    }
</script>
</body>
</html>